<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" type="image/png" href="./img/favicon2.jpg">
    <title>Presente</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        h1 {
            text-align: center;
            margin-top: 20px;
            color: #fff;
        }

        /* ****************************************************************** */
        /* INICIO DE ESTILOS A√ëADIDOS POR MI (PARA MANEJAR TEXTOS LARGOS) */

        /* Estilos para el t√≠tulo de la clase en el encabezado (h1 #tituloClase) */
        #tituloClase {
            white-space: nowrap;
            /* Mi estilo: Evita que el texto salte a la siguiente l√≠nea */
            overflow: hidden;
            /* Mi estilo: Oculta el texto que se desborda */
            text-overflow: ellipsis;
            /* Mi estilo: A√±ade "..." al final del texto recortado */
            /* Mi estilo: Necesario para que overflow y text-overflow funcionen */
            display: inline-block;
            /* Mi estilo: Asegura que ocupe el ancho adecuado, puedes ajustar el 80% si necesitas m√°s/menos espacio */
            max-width: calc(100% - 80px);
            /* Mi estilo: Deja espacio para el bot√≥n de retroceso */
            vertical-align: middle;
            /* Mi estilo: Alinea verticalmente con el bot√≥n */
            margin: 0;
            /* Mi estilo: Reinicia m√°rgenes para un control preciso */
            padding-left: 10px;
            /* Mi estilo: Peque√±o padding si es necesario por el bot√≥n */
        }

        /* Ajuste para el contenedor del encabezado si el h1 es inline-block */
        .app-header {
            display: flex;
            /* Mi estilo: Usa flexbox para alinear el bot√≥n y el t√≠tulo */
            align-items: center;
            /* Mi estilo: Centra verticalmente los elementos */
            padding: 10px;
            /* Mi estilo: A√±ade un poco de padding al header */
            position: relative;
            /* Mi estilo: Si el back-btn es absoluto, su padre debe ser relativo */
        }

        /* Estilos para el nombre del alumno dentro de cada tarjeta de asistencia */
        .card .name {
            white-space: nowrap;
            /* Mi estilo: Evita saltos de l√≠nea para el nombre del alumno */
            overflow: hidden;
            /* Mi estilo: Oculta el texto que se desborda */
            text-overflow: ellipsis;
            /* Mi estilo: A√±ade "..." al final del nombre recortado */
            display: block;
            /* Mi estilo: Necesario para que overflow y text-overflow funcionen */
            max-width: 100%;
            /* Mi estilo: Asegura que ocupe el ancho disponible en su contenedor */
            /* MANT√âN TUS ESTILOS DE FUENTE Y COLOR ORIGINALES AQU√ç */
            /* Por ejemplo, el tama√±o de fuente y color que ya tenga .name en style.css */
        }

        /* FIN DE ESTILOS A√ëADIDOS POR MI (PARA MANEJAR TEXTOS LARGOS) */
        /* ****************************************************************** */
    </style>
</head>

<body>
    <header class="app-header">
        <button class="back-btn" onclick="volverAClases()">&larr;</button>
        <h2 id="tituloClase">Matem√°ticas - 1¬∞A</h2>
    </header>
    <div class="app-container">
        <p class="date" id="fechaActual"></p>

        <div id="listaAlumnosContainer">
        </div>

        <div class="botonera">
            <button onclick="cerrarRegistro()">CERRAR<br>REGISTRO</button>
            <button onclick="marcarTodos('P')">TODOS<br>PRESENTES</button>
        </div>
    </div>

    <script>
        // Funci√≥n para obtener par√°metro de la URL (ESTO YA ESTABA)
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Funci√≥n para formatear fecha (ESTO YA ESTABA)
        function formatearFecha(fecha) {
            const opciones = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return fecha.toLocaleDateString('es-ES', opciones);
        }

        // Funci√≥n para generar las tarjetas de alumnos (ESTO YA ESTABA)
        function generarTarjetasAlumnos(alumnos) {
            const container = document.getElementById('listaAlumnosContainer');
            container.innerHTML = '';

            alumnos.forEach((alumno, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                <div class="photo">üë§</div>
                <div class="info">
                    <div class="name">${alumno}</div> <div class="radios">
                        <div class="radio-group">
                            <label for="alumno${index}_p">P</label>
                            <input type="radio" id="alumno${index}_p" name="asistencia${index}" value="P">
                        </div>
                        <div class="radio-group">
                            <label for="alumno${index}_a">A</label>
                            <input type="radio" id="alumno${index}_a" name="asistencia${index}" value="A">
                        </div>
                        <div class="radio-group">
                            <label for="alumno${index}_t">T</label>
                            <input type="radio" id="alumno${index}_t" name="asistencia${index}" value="T">
                        </div>
                    </div>
                </div>
                `;
                container.appendChild(card);
            });
        }

        // Funci√≥n principal al cargar la p√°gina (ESTO YA ESTABA)
        document.addEventListener('DOMContentLoaded', () => {
            const claseId = getQueryParam('claseId');
            if (!claseId) {
                // MODIFICACI√ìN: Usar SweetAlert para alertas (ESTO YA ESTABA)
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Clase no especificada. Redirigiendo a clases.',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = 'clases.html';
                });
                return;
            }

            // Obtener la clase del localStorage (ESTO YA ESTABA)
            const clases = JSON.parse(localStorage.getItem('clases')) || [];
            const clase = clases.find(c => c.id == claseId);
            if (!clase) {
                // MODIFICACI√ìN: Usar SweetAlert para alertas (ESTO YA ESTABA)
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Clase no encontrada. Redirigiendo a clases.',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = 'clases.html';
                });
                return;
            }

            // Mostrar datos de la clase
            // Mi l√≥gica: El t√≠tulo de la clase y el curso se combinan aqu√≠. 
            // El CSS se encargar√° de recortarlo si es muy largo.
            document.getElementById('tituloClase').textContent = `${clase.nombre} - ${clase.curso}`;

            // Mostrar fecha actual (ESTO YA ESTABA)
            const fechaActual = new Date();
            document.getElementById('fechaActual').textContent = formatearFecha(fechaActual);

            // Generar tarjetas de alumnos (ESTO YA ESTABA)
            generarTarjetasAlumnos(clase.alumnos);
        });

        // ‚úÖ Marca todos los radios con un valor dado (P, A o T) (ESTO YA ESTABA)
        function marcarTodos(valor) {
            const radios = document.querySelectorAll(`input[type="radio"][value="${valor}"]`);
            radios.forEach(radio => radio.checked = true);
        }

        // ‚úÖ Cierra el registro y guarda la asistencia (ESTO YA ESTABA)
        function cerrarRegistro() {
            const radios = document.querySelectorAll('input[type="radio"]');
            const grupos = {};

            // Agrupar por name (cada grupo representa un alumno)
            radios.forEach(radio => {
                const name = radio.name;
                if (!grupos[name]) grupos[name] = [];
                grupos[name].push(radio);
            });

            // Para cada grupo (alumno), si no est√° marcado ni P ni T, marcar A
            Object.values(grupos).forEach(grupo => {
                const algunoMarcado = grupo.find(r => r.checked && (r.value === "P" || r.value === "T"));
                if (!algunoMarcado) {
                    const ausente = grupo.find(r => r.value === "A");
                    if (ausente) ausente.checked = true;
                }
            });

            // Guardar el registro y luego mostrar SweetAlert
            guardarAsistencia();
            // La redirecci√≥n se har√° dentro de guardarAsistencia() ahora
        }

        // Volver a la p√°gina de clases (ya no se llama directamente desde cerrarRegistro) (ESTO YA ESTABA)
        function volverAClases() {
            window.location.href = 'clases.html';
        }

        // Guardar la asistencia en localStorage (ESTO YA ESTABA)
        function guardarAsistencia() {
            const claseId = getQueryParam('claseId');
            if (!claseId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo guardar la asistencia: ID de clase no encontrado.',
                    confirmButtonText: 'Entendido'
                }).then(() => {
                    volverAClases();
                });
                return;
            }

            const fecha = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
            const registros = [];

            // Recorrer todas las tarjetas de alumnos
            document.querySelectorAll('.card').forEach((card, index) => {
                const nombre = card.querySelector('.name').textContent;
                // Obtener el estado seleccionado (P, A o T)
                const estado = card.querySelector(`input[name="asistencia${index}"]:checked`)?.value || 'A';

                // Convertir P, A, T a Presente, Ausente, Tardanza para legibilidad en registros
                let estadoCompleto;
                switch (estado) {
                    case 'P':
                        estadoCompleto = 'Presente';
                        break;
                    case 'A':
                        estadoCompleto = 'Ausente';
                        break;
                    case 'T':
                        estadoCompleto = 'Tardanza';
                        break;
                    default:
                        estadoCompleto = 'Desconocido'; // Por si acaso
                }

                registros.push({ nombre, estado: estadoCompleto });
            });

            // Guardar en localStorage con clave √∫nica
            const clave = `asistencia_${claseId}_${fecha.replace(/-/g, '_')}`; // Asegura YYYY_MM_DD
            localStorage.setItem(clave, JSON.stringify(registros));

            // MODIFICACI√ìN: Mostrar mensaje de √©xito con SweetAlert2 (ESTO YA ESTABA)
            Swal.fire({
                title: 'Registro Cerrado',
                text: `Asistencia del ${formatearFecha(new Date())} guardada correctamente.`,
                icon: 'success',
                timer: 2000, // La alerta se cierra autom√°ticamente despu√©s de 2 segundos
                showConfirmButton: false, // Oculta el bot√≥n de "OK"
                allowOutsideClick: false // No permite cerrar haciendo clic afuera
            }).then(() => {
                // Esta parte se ejecuta DESPU√âS de que la alerta se cierra
                volverAClases();
            });
        }
    </script>
</body>

</html>